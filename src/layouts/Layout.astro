---
import "../styles/global.css";
import { getEntry } from "astro:content";
import Footer from "../components/Footer.astro";
import ContactModal from "../components/ContactModal.astro";
import Navigation from "../components/Navigation.astro";
import Search from "../components/Search.astro";

interface Props {
  title: string;
  currentPath: string;
  description?: string;
  canonicalUrl?: string;
  image?: string;
  ogType?: string;
  robots?: string;
  additionalStructuredData?: Array<Record<string, unknown>>;
}

const defaultSite = "https://parijatkhan.in";

const {
  title,
  currentPath,
  description,
  canonicalUrl,
  image,
  ogType = "website",
  robots,
  additionalStructuredData = [],
} = Astro.props;

const resumeData = await getEntry("resume", "main");

const siteOrigin = Astro.site?.origin ?? defaultSite;
const canonical = canonicalUrl ?? new URL(currentPath || "/", siteOrigin).toString();
const fallbackDescription =
  description ??
  resumeData?.data.header.summary ??
  "Solution Designer and full-stack engineer building resilient systems.";
const pageDescription = fallbackDescription;
const encodedTitle = encodeURIComponent(`${title} | ${resumeData?.data.header.name ?? "Portfolio"}`);
const imageUrl = image ?? `${siteOrigin}/api/og.png?title=${encodedTitle}`;
const robotsContent = robots ?? "index,follow";
const ownerName = resumeData?.data.header.name ?? "Parijat Khan";
const sameAs = [
  resumeData?.data.header.linkedin,
  resumeData?.data.header.github,
]
  .filter(Boolean)
  .map((url) => url as string);

const personSchema: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: ownerName,
  jobTitle: resumeData?.data.header.title,
  description: pageDescription,
  url: siteOrigin,
  image: `${siteOrigin}/favicon.svg`,
};

if (sameAs.length) {
  personSchema.sameAs = sameAs;
}

const websiteSchema: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: `${ownerName} Portfolio`,
  url: siteOrigin,
  potentialAction: {
    "@type": "SearchAction",
    target: `${siteOrigin}/?q={search_term_string}`,
    "query-input": "required name=search_term_string",
  },
};

const structuredData = [
  personSchema,
  websiteSchema,
  ...additionalStructuredData.filter(Boolean),
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | {resumeData?.data.header.name}</title>
    <meta name="description" content={pageDescription} />
    <meta name="robots" content={robotsContent} />
    <meta name="author" content={ownerName} />
    <link rel="canonical" href={canonical} />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="apple-touch-icon" sizes="180x180" href="/pwa-192x192.png" />
    <meta name="application-name" content={ownerName} />
    <meta name="theme-color" content="#0f172a" />
    <meta property="og:title" content={`${title} | ${ownerName}`} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:site_name" content={`${ownerName} Portfolio`} />
    <meta property="og:locale" content="en_NZ" />
    <meta property="og:image:alt" content={`${title} | ${ownerName}`} />
    {structuredData.length > 0 && (
      <script
        type="application/ld+json"
        set:html={JSON.stringify(structuredData)}
      />
    )}
  </head>
  <body class="min-h-screen bg-white font-sans text-slate-900 flex flex-col">
    <!-- Navbar -->
    <Navigation currentPath={currentPath} />

    <!-- Main Content -->
    <main class="grow flex flex-col">
      <slot />
    </main>

    <!-- Compact Footer -->
    <Footer />

    <!-- Contact Modal -->
    <ContactModal />

    <!-- Global Search Modal -->
    <Search />

    <!-- Client-side Scripts -->
    <script define:vars={{ resumeData }}>
      // --- Mobile Menu ---
      const mobileBtn = document.getElementById("mobile-menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");
      const menuIcon = document.getElementById("menu-icon");
      const closeIcon = document.getElementById("close-icon");

      mobileBtn?.addEventListener("click", () => {
        mobileMenu?.classList.toggle("hidden");
        menuIcon?.classList.toggle("hidden");
        closeIcon?.classList.toggle("hidden");
      });

      // --- Contact Modal ---
      const contactModal = document.getElementById("contact-modal");
      const closeContactBtn = document.getElementById("close-contact");
      const copyEmailBtn = document.getElementById("copy-email-btn");

      const openContact = () =>
        contactModal?.classList.replace("hidden", "flex");
      const closeContact = () =>
        contactModal?.classList.replace("flex", "hidden");

      document
        .getElementById("contact-trigger")
        ?.addEventListener("click", openContact);
      document
        .getElementById("mobile-contact-trigger")
        ?.addEventListener("click", () => {
          openContact();
          mobileMenu?.classList.add("hidden"); // Close menu
        });
      document
        .getElementById("footer-contact-trigger")
        ?.addEventListener("click", openContact);
      closeContactBtn?.addEventListener("click", closeContact);

      // Copy Email Logic
      copyEmailBtn?.addEventListener("click", () => {
        navigator.clipboard.writeText(resumeData.header.email).then(() => {
          const btnText = copyEmailBtn.querySelector(".btn-text");
          const copyIcon = copyEmailBtn.querySelector(".copy-icon");
          const checkIcon = copyEmailBtn.querySelector(".check-icon");

          if (btnText) btnText.textContent = "Copied";
          copyIcon?.classList.add("hidden");
          checkIcon?.classList.remove("hidden");
          copyEmailBtn.classList.replace("bg-indigo-50", "bg-green-100");
          copyEmailBtn.classList.replace("text-indigo-700", "text-green-700");

          setTimeout(() => {
            if (btnText) btnText.textContent = "Copy";
            copyIcon?.classList.remove("hidden");
            checkIcon?.classList.add("hidden");
            copyEmailBtn.classList.replace("bg-green-100", "bg-indigo-50");
            copyEmailBtn.classList.replace("text-green-700", "text-indigo-700");
          }, 2000);
        });
      });

      // --- Global Search ---
      const searchModal = document.getElementById("search-modal");
      const searchInput = document.getElementById("global-search-input");
      const searchStatus = document.getElementById("search-status");
      const searchResultsList = document.getElementById("search-results-list");
      const closeSearch = document.getElementById("close-search");

      let pagefindInstance = null;
      let pagefindLoader = null;
      let currentQuery = "";

      const setStatusMessage = (message, subtext = "") => {
        if (!searchStatus) return;
        searchStatus.innerHTML = "";

        const messageEl = document.createElement("p");
        messageEl.className = "text-base";
        messageEl.textContent = message;
        searchStatus.appendChild(messageEl);

        if (subtext) {
          const subEl = document.createElement("p");
          subEl.className = "text-xs text-slate-400/80";
          subEl.textContent = subtext;
          searchStatus.appendChild(subEl);
        }

        searchStatus.classList.remove("hidden");
        if (searchResultsList) {
          searchResultsList.classList.add("hidden");
          searchResultsList.innerHTML = "";
        }
      };

      const getPagefindCategory = (url = "") => {
        if (url.includes("/projects")) return "Projects";
        if (url.includes("/publications") || url.includes("/research"))
          return "Research";
        if (url.includes("/blogs") || url.includes("/blog")) return "Blog";
        if (url === "/" || url.includes("/cv")) return "CV";
        return "Site";
      };

      const renderResults = (items) => {
        if (!searchResultsList) return;
        const html = items
          .map(
            (result) => `
              <a
                href="${result.url}"
                class="block p-4 bg-white hover:bg-indigo-50 rounded-lg border border-slate-200 shadow-sm transition-colors"
                role="listitem"
              >
                <div class="text-xs font-semibold uppercase tracking-wider text-indigo-500 mb-1">
                  ${getPagefindCategory(result.url)}
                </div>
                <div class="font-semibold text-slate-900 mb-1">
                  ${result.meta?.title ?? result.url}
                </div>
                <div class="text-sm text-slate-600 leading-relaxed">${result.excerpt ?? ""}</div>
              </a>
            `
          )
          .join("");

        if (!html) {
          setStatusMessage("No results found.", "Try a different keyword.");
          return;
        }

        searchResultsList.innerHTML = html;
        searchResultsList.classList.remove("hidden");
        searchStatus?.classList.add("hidden");
      };

      const loadPagefind = async () => {
        if (pagefindInstance) return pagefindInstance;
        if (!pagefindLoader) {
          pagefindLoader = import("/pagefind/pagefind.js")
            .then((module) => {
              const instance = module?.default?.search
                ? module.default
                : module;
              instance?.init?.();
              return instance;
            })
            .catch((error) => {
              console.warn("Unable to load Pagefind", error);
              setStatusMessage(
                "Search index unavailable.",
                "Run the build step (npm run build && pagefind --site dist) to regenerate Pagefind assets."
              );
              return null;
            });
        }

        pagefindInstance = await pagefindLoader;
        pagefindLoader = null;
        return pagefindInstance;
      };

      const performSearch = async (query) => {
        currentQuery = query;

        if (!query) {
          setStatusMessage(
            "Type to search across pages...",
            "Results are powered by Pagefind."
          );
          return;
        }

        setStatusMessage(`Searching “${query}”...`);
        const pagefind = await loadPagefind();
        if (!pagefind) return;

        const searchResponse = await pagefind.search(query);
        if (currentQuery !== query) return;

        if (!searchResponse?.results?.length) {
          setStatusMessage("No results found.", "Try another keyword.");
          return;
        }

        const hydrated = await Promise.all(
          searchResponse.results.slice(0, 12).map(async (result) => {
            try {
              return await result.data();
            } catch (error) {
              console.warn("Unable to hydrate Pagefind result", error);
              return null;
            }
          })
        );

        const validResults = hydrated.filter(Boolean);
        if (!validResults.length) {
          setStatusMessage("No results found.", "Try another keyword.");
          return;
        }

        renderResults(validResults);
      };

      const openSearchModal = () => {
        if (!searchModal) return;
        if (searchModal.classList.contains("hidden")) {
          searchModal.classList.replace("hidden", "flex");
        }
        searchInput?.focus();
        loadPagefind();
      };

      const closeSearchModal = () => {
        if (!searchModal) return;
        searchModal.classList.replace("flex", "hidden");
      };

      document
        .getElementById("search-trigger")
        ?.addEventListener("click", openSearchModal);
      closeSearch?.addEventListener("click", closeSearchModal);

      // Keyboard Shortcut (Cmd+K)
      document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          openSearchModal();
        }
        if (e.key === "Escape") {
          closeSearchModal();
          contactModal?.classList.replace("flex", "hidden");
        }
      });

      searchInput?.addEventListener("input", (event) => {
        const value = event.target.value.trim();
        performSearch(value);
      });
    </script>
  </body>
</html>
