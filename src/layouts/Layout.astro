---
import "../styles/global.css";
import { getEntry } from "astro:content";
import Footer from "../components/Footer.astro";
import ContactModal from "../components/ContactModal.astro";
import Navigation from "../components/Navigation.astro";
import Search from "../components/Search.astro";

interface Props {
  title: string;
  currentPath: string;
}

const { title, currentPath } = Astro.props;

const resumeData = await getEntry("resume", "main");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | {resumeData?.data.header.name}</title>
  </head>
  <body class="min-h-screen bg-white font-sans text-slate-900 flex flex-col">
    <!-- Navbar -->
    <Navigation currentPath={currentPath} />

    <!-- Main Content -->
    <main class="grow">
      <slot />
    </main>

    <!-- Compact Footer -->
    <Footer />

    <!-- Contact Modal -->
    <ContactModal />

    <!-- Global Search Modal -->
    <Search />

    <!-- Client-side Scripts -->
    <script define:vars={{ resumeData }}>
      // --- Mobile Menu ---
      const mobileBtn = document.getElementById("mobile-menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");
      const menuIcon = document.getElementById("menu-icon");
      const closeIcon = document.getElementById("close-icon");

      mobileBtn?.addEventListener("click", () => {
        mobileMenu?.classList.toggle("hidden");
        menuIcon?.classList.toggle("hidden");
        closeIcon?.classList.toggle("hidden");
      });

      // --- Contact Modal ---
      const contactModal = document.getElementById("contact-modal");
      const closeContactBtn = document.getElementById("close-contact");
      const copyEmailBtn = document.getElementById("copy-email-btn");

      const openContact = () =>
        contactModal?.classList.replace("hidden", "flex");
      const closeContact = () =>
        contactModal?.classList.replace("flex", "hidden");

      document
        .getElementById("contact-trigger")
        ?.addEventListener("click", openContact);
      document
        .getElementById("mobile-contact-trigger")
        ?.addEventListener("click", () => {
          openContact();
          mobileMenu?.classList.add("hidden"); // Close menu
        });
      document
        .getElementById("footer-contact-trigger")
        ?.addEventListener("click", openContact);
      closeContactBtn?.addEventListener("click", closeContact);

      // Copy Email Logic
      copyEmailBtn?.addEventListener("click", () => {
        navigator.clipboard.writeText(resumeData.header.email).then(() => {
          const btnText = copyEmailBtn.querySelector(".btn-text");
          const copyIcon = copyEmailBtn.querySelector(".copy-icon");
          const checkIcon = copyEmailBtn.querySelector(".check-icon");

          if (btnText) btnText.textContent = "Copied";
          copyIcon?.classList.add("hidden");
          checkIcon?.classList.remove("hidden");
          copyEmailBtn.classList.replace("bg-indigo-50", "bg-green-100");
          copyEmailBtn.classList.replace("text-indigo-700", "text-green-700");

          setTimeout(() => {
            if (btnText) btnText.textContent = "Copy";
            copyIcon?.classList.remove("hidden");
            checkIcon?.classList.add("hidden");
            copyEmailBtn.classList.replace("bg-green-100", "bg-indigo-50");
            copyEmailBtn.classList.replace("text-green-700", "text-indigo-700");
          }, 2000);
        });
      });

      // --- Global Search ---
      const searchModal = document.getElementById("search-modal");
      const searchInput = document.getElementById("global-search-input");
      const searchResults = document.getElementById("search-results");
      const closeSearch = document.getElementById("close-search");

      const toggleSearch = () => {
        if (searchModal?.classList.contains("hidden")) {
          searchModal.classList.replace("hidden", "flex");
          searchInput?.focus();
        } else {
          searchModal?.classList.replace("flex", "hidden");
        }
      };

      document
        .getElementById("search-trigger")
        ?.addEventListener("click", toggleSearch);
      closeSearch?.addEventListener("click", toggleSearch);

      // Keyboard Shortcut (Cmd+K)
      document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          toggleSearch();
        }
        if (e.key === "Escape") {
          searchModal?.classList.replace("flex", "hidden");
          contactModal?.classList.replace("flex", "hidden");
        }
      });

      // Search Logic
      searchInput?.addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        if (!query) {
          searchResults.innerHTML =
            '<div class="text-center text-slate-400 py-12"><p>Type to search...</p></div>';
          return;
        }

        const matches = {
          projects: resumeData.projects.filter(
            (p) =>
              p.name.toLowerCase().includes(query) ||
              p.tags.some((t) => t.toLowerCase().includes(query))
          ),
          research: resumeData.publications.filter(
            (p) =>
              p.title.toLowerCase().includes(query) ||
              p.tags.some((t) => t.toLowerCase().includes(query))
          ),
          blogs: resumeData.blogs.filter(
            (b) =>
              b.title.toLowerCase().includes(query) ||
              b.tags.some((t) => t.toLowerCase().includes(query))
          ),
          skills: resumeData.skills
            .flatMap((s) => s.items)
            .filter((i) => i.toLowerCase().includes(query)),
        };

        if (
          !matches.projects.length &&
          !matches.research.length &&
          !matches.blogs.length &&
          !matches.skills.length
        ) {
          searchResults.innerHTML =
            '<div class="text-center text-slate-500 py-8">No results found.</div>';
          return;
        }

        let html = "";

        if (matches.projects.length) {
          html += `<div class="mb-4"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Projects</h3>`;
          matches.projects.forEach((p) => {
            html += `<a href="/projects/${p.id}" class="block p-3 bg-white hover:bg-indigo-50 rounded-lg border border-slate-200 mb-2">
              <div class="font-bold text-slate-900">${p.name}</div>
              <div class="text-xs text-slate-500">${p.tech}</div>
            </a>`;
          });
          html += `</div>`;
        }

        if (matches.research.length) {
          html += `<div class="mb-4"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Research</h3>`;
          matches.research.forEach((p) => {
            html += `<a href="/research/${p.id}" class="block p-3 bg-white hover:bg-indigo-50 rounded-lg border border-slate-200 mb-2">
              <div class="font-bold text-slate-900 truncate">${p.title}</div>
              <div class="text-xs text-slate-500">${p.year}</div>
            </a>`;
          });
          html += `</div>`;
        }

        if (matches.blogs.length) {
          html += `<div class="mb-4"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Blog</h3>`;
          matches.blogs.forEach((b) => {
            html += `<a href="/blog/${b.id}" class="block p-3 bg-white hover:bg-indigo-50 rounded-lg border border-slate-200 mb-2">
              <div class="font-bold text-slate-900 truncate">${b.title}</div>
              <div class="text-xs text-slate-500">${b.date}</div>
            </a>`;
          });
          html += `</div>`;
        }

        if (matches.skills.length) {
          html += `<div><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Skills</h3><div class="flex flex-wrap gap-2">`;
          matches.skills.forEach((s) => {
            html += `<a href="/cv" class="px-2 py-1 bg-white border border-slate-200 rounded text-sm text-slate-700 hover:text-indigo-800">${s}</a>`;
          });
          html += `</div></div>`;
        }

        searchResults.innerHTML = html;
      });
    </script>
  </body>
</html>
