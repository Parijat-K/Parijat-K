---
import { getCollection, getEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import {
  Printer,
  MapPin,
  Mail,
  Phone,
  Linkedin,
  Github,
  Globe,
  Briefcase,
  Cpu,
  FolderGit,
  BookOpen,
  GraduationCap,
  Award,
  Trophy,
} from "lucide-astro";

const resumeData = await getEntry("resume", "main");
const projects = await getCollection("projects");
const publications = await getCollection("publications");

const hasAdditionalTitles =
  resumeData?.data.header.additionalTitles &&
  resumeData?.data.header.additionalTitles.length > 0;
const hasAwards = resumeData?.data.awards && resumeData.data.awards.length > 0;
const hasProjects = projects && projects.length > 0;
const hasPublications = publications && publications.length > 0;

const normalizeUrl = (url?: string | null) => {
  if (!url) return "";
  return /^https?:\/\//i.test(url) ? url : `https://${url}`;
};

const formatUrlForDisplay = (url?: string | null) => {
  if (!url) return "";
  return url.replace(/^https?:\/\//i, "").replace(/\/$/, "");
};

const linkedinUrl = normalizeUrl(resumeData?.data.header.linkedin);
const githubUrl = normalizeUrl(resumeData?.data.header.github);
const siteUrl = Astro.site ? Astro.site.toString().replace(/\/$/, "") : "";

const linkedinDisplay = formatUrlForDisplay(linkedinUrl);
const githubDisplay = formatUrlForDisplay(githubUrl);
const siteDisplay = formatUrlForDisplay(siteUrl);

const siteOrigin = Astro.site?.origin ?? "https://parijatkhan.in";
const resumeDescription = `${resumeData?.data.header.name ?? "Solution Designer"} CV summarizing enterprise architecture, platform modernization, and research highlights.`;
const resumeStructuredData = [
  {
    "@context": "https://schema.org",
    "@type": "ProfilePage",
    name: `${resumeData?.data.header.name ?? "Parijat Khan"} Resume`,
    url: `${siteOrigin}/cv`,
    about: resumeData?.data.header.summary,
  },
];
---

<Layout
  title="Resume"
  currentPath="/cv"
  description={resumeDescription}
  canonicalUrl={`${siteOrigin}/cv`}
  additionalStructuredData={resumeStructuredData}
  robots="index,follow"
>
  <div class="cv-shell">
    <button
      onclick="window.print()"
      class="cv-print-button"
      title="Print or Save as PDF"
    >
      <Printer size={20} class="cv-icon cv-icon--button" />
      <span>Print CV</span>
    </button>

    <div class="cv-page">
      <header class="cv-header">
        <div class="cv-header__top">
          <div class="cv-header__identity">
            <h1>{resumeData?.data.header.name}</h1>
            <p class="cv-header__role">{resumeData?.data.header.title}</p>
            {
              hasAdditionalTitles && (
                <p class="cv-header__extra">
                  {resumeData?.data.header.additionalTitles?.join(" | ")}
                </p>
              )
            }
          </div>

          <div class="cv-header__contact">
            {
              resumeData?.data.header.location && (
                <div class="cv-contact-item">
                  <MapPin size={16} class="cv-icon" />
                  <span>{resumeData?.data.header.location}</span>
                </div>
              )
            }
            <div class="cv-contact-item">
              <Mail size={16} class="cv-icon" />
              <a href={`mailto:${resumeData?.data.header.email}`}>
                {resumeData?.data.header.email}
              </a>
            </div>
            <div class="cv-contact-item">
              <Phone size={16} class="cv-icon" />
              <span>{resumeData?.data.header.phone}</span>
            </div>
            <div class="cv-contact-links">
              {
                linkedinUrl && (
                  <a
                    href={linkedinUrl}
                    target="_blank"
                    rel="noreferrer"
                    class="cv-contact-link cv-contact-link--icon-only"
                    aria-label={`LinkedIn: ${linkedinDisplay || linkedinUrl.replace(/^https?:\/\//i, "")}`}
                  >
                    <Linkedin size={18} class="cv-icon" />
                    <span>{linkedinDisplay || linkedinUrl.replace(/^https?:\/\//i, "")}</span>
                  </a>
                )
              }
              {
                githubUrl && (
                  <a
                    href={githubUrl}
                    target="_blank"
                    rel="noreferrer"
                    class="cv-contact-link cv-contact-link--icon-only"
                    aria-label={`GitHub: ${githubDisplay || githubUrl.replace(/^https?:\/\//i, "")}`}
                  >
                    <Github size={18} class="cv-icon" />
                    <span>{githubDisplay || githubUrl.replace(/^https?:\/\//i, "")}</span>
                  </a>
                )
              }
              {
                siteUrl && (
                  <a
                    href={siteUrl}
                    target="_blank"
                    rel="noreferrer"
                    class="cv-contact-link cv-contact-link--site"
                  >
                    <Globe size={18} class="cv-icon" />
                    <span>{siteDisplay || siteUrl.replace(/^https?:\/\//i, "")}</span>
                  </a>
                )
              }
            </div>
          </div>
        </div>

        {
          resumeData?.data.header.summary && (
            <div class="cv-header__summary">
              <p>{resumeData?.data.header.summary}</p>
            </div>
          )
        }
      </header>

      <div class="cv-body">
        <section class="cv-main-column">
          <div class="cv-section">
            <h2 class="cv-section-title">
              <Briefcase size={20} class="cv-icon" />
              <span>Experience</span>
            </h2>
            <div class="cv-timeline">
              {
                resumeData?.data.experience.map((companyData) => (
                  <div class="cv-timeline-entry">
                    <div class="cv-company">{companyData.company}</div>
                    <div class="cv-role-list">
                      {companyData.roles.map((role) => (
                        <div class="cv-role">
                          <div class="cv-role__meta">
                            <h3 class="cv-role__title">{role.title}</h3>
                            <span class="cv-role__period">{role.period}</span>
                          </div>
                          <ul class="cv-role__points">
                            {role.achievements.map((point) => (
                              <li>{point}</li>
                            ))}
                          </ul>
                        </div>
                      ))}
                    </div>
                  </div>
                ))
              }
            </div>
          </div>
        </section>

        <aside class="cv-sidebar">
          <div class="cv-section">
            <h2 class="cv-section-title">
              <Cpu size={20} class="cv-icon" />
              <span>Skills</span>
            </h2>
            <div class="cv-skill-groups">
              {
                resumeData?.data.skills.map((skillGroup) => (
                  <div class="cv-skill-group">
                    <h3 class="cv-skill-title">{skillGroup.category}</h3>
                    <div class="cv-skill-tags">
                      {skillGroup.items.map((item) => (
                        <span class="cv-skill-tag">{item}</span>
                      ))}
                    </div>
                  </div>
                ))
              }
            </div>
          </div>
        </aside>
      </div>

      {
        hasProjects && (
          <section class="cv-section cv-section--full cv-section--print-break">
            <h2 class="cv-section-title">
              <FolderGit size={20} class="cv-icon" />
              <span>Key Projects</span>
            </h2>
            <div class="cv-card-grid">
              {projects
                .filter((p: any) => p.data.featured)
                .slice(0, 3)
                .map((project: any) => (
                  <article class="cv-project-card">
                    <div class="cv-project-card__header">
                      <h3 class="cv-project-card__title">{project.data.name}</h3>
                    </div>
                    {project.data.shortDescription ? (
                      <p>{project.data.shortDescription}</p>
                    ) : project.data.description ? (
                      <p>{project.data.description}</p>
                    ) : null}
                  </article>
                ))}
            </div>
          </section>
        )
      }

      {
        hasPublications && (
          <section class="cv-section cv-section--full">
            <h2 class="cv-section-title">
              <BookOpen size={20} class="cv-icon" />
              <span>Publications &amp; Research</span>
            </h2>
            <div class="cv-publications">
              {publications
                .filter((p: any) => p.data.featured)
                .slice(0, 3)
                .map((pub: any) => (
                  <article class="cv-publication">
                    <div class="cv-publication__details">
                      <a
                        href={`https://${pub.link}`}
                        target="_blank"
                        rel="noreferrer"
                      >
                        {pub.title}
                      </a>
                      {pub.conference && (
                        <p>{pub.conference}</p>
                      )}
                    </div>
                    <div class="cv-publication__year">{pub.year}</div>
                  </article>
                ))}
            </div>
          </section>
        )
      }

      <section class="cv-section cv-section--full cv-section--muted">
        <div class="cv-education">
          <div>
            <h2 class="cv-section-title">
              <GraduationCap size={20} class="cv-icon" />
              <span>Education</span>
            </h2>
            <div class="cv-education-list">
              {
                resumeData?.data.education.map((edu) => (
                  <article class="cv-education-item">
                    <h3>{edu.degree}</h3>
                    <p class="cv-education__institution">{edu.institution}</p>
                    <p class="cv-education__period">{edu.period}</p>
                  </article>
                ))
              }
            </div>
          </div>

          <div>
            <h2 class="cv-section-title">
              <Award size={20} class="cv-icon" />
              <span>Certifications</span>
            </h2>
            <div class="cv-cert-grid">
              {
                resumeData?.data.certificates?.map((cert) => (
                  <article class="cv-cert">
                    <a href={cert.link} target="_blank" rel="noreferrer">
                      {cert.name}
                    </a>
                    <p>
                      <span>{cert.issuer}</span>
                      <span>&bull;</span>
                      <span>{cert.date}</span>
                    </p>
                  </article>
                ))
              }
            </div>
          </div>
        </div>

        {
          hasAwards && (
            <div class="cv-awards">
              <h2 class="cv-section-title">
                <Trophy size={20} class="cv-icon" />
                <span>Honors &amp; Awards</span>
              </h2>
              <div class="cv-award-grid">
                {resumeData?.data.awards.map((award) => (
                  <article class="cv-award">
                    <h3>{award.title}</h3>
                    <p>{award.issuer}</p>
                    <span>{award.year}</span>
                  </article>
                ))}
              </div>
            </div>
          )
        }
      </section>
    </div>
  </div>
</Layout>
